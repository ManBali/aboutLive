### 直播中的点播视频服务我们是这么用的

##### 背景：

我们业务场景实际上使用的是双师模式，即在整个直播过程中由主讲老师+名师的录播资源相互交替给学生呈现；

##### 可选方案

1. 主讲老师的视频源+录播资源全部通过webRtc方式推送至学生端；
2. 主讲老师视频源直推至学生端，录播资源通过信令方式，提前下发至客户端；

##### 为什么我们选择了方案2？

相对于方案1来说，方案2明显要复杂很多；无非就是如下个原因

```
一、成本
二、降低老师的上行负载
三、分散学生下行负载
```

###### 成本？

第一版我们是基于声网服务上构建，其计费方式是按照在线学生所在时长来计费；实际上如果能将录播资源提前通过CDN方式下发，那么可为我们节省一大比的开销；要知道当时使用webRtc的通道大致是使用CDN通道的近10倍费用；

###### 降低老师的上行负载

起初我们为老师集中组建了直播仓，也单独拉了一根网络，但老板们对于画质要求较高，这样就会带来必然的上行网络压力倍增；另外一个方面由于老师使用的是浏览器上课，稍高一些的编码压力有可能导致浏览器Crash,给老师上课期间增加不少的不确定性；

###### 分散学生下行负载

提前给待上课的学生推送上课课件资源，或者是在教室进行预热时进行课前的预加载。当主讲老师在切换名师资源时，实际上播放的是本地加密资源；经我们计算，目前大部份家用网络，可以在1~2分钟内全部加载完；

```
实际上2方案的不足之处即如果学生未能来得及提前下载，在插播视频时候会有一些的延迟，主要视用户网络而定
```

##### 视频预加载策略有几个点

1、有多路CDN资源下载，出现下载失败可自动切换线路；

2、收到插播信令控件，若本地没有选择线上资源进行加载（效果最实际上不是很好）

3、视频播放器要支持可定位拖动

4、视频关键帧不用太满，需要保证每秒有一个关键帧，不然很容易出现seek操作时定位不准与老师播放进度不同步

5、为了让起播速度更快，可以使用mp4Box将关键视频元信息提取至视频头部；

6、根据我们多次实验验证的标准，找到了一个大部份用户可接受的视频尺寸，于是乎我们将其设置成了默认加载的视频；其尺寸信息如下：1280*720 25帧 1M码左右

7、需要定义与老师端进行时间同步，若是在最小时间差3s以内则让其自动播放，若在3s开外，会根据信令拉齐播放进度；















